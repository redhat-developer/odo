schemaVersion: 2.2.0
metadata:
  name: nodejs
variables:
  CONTAINER_IMAGE: quay.io/unknown-account/myimage

components:
  - container:
      endpoints:
        - name: http-3000
          targetPort: 3000
      image: registry.access.redhat.com/ubi8/nodejs-14:latest
    name: runtime

  - name: image-build-component
    image:
      imageName: "{{CONTAINER_IMAGE}}"
      dockerfile:
        uri: ./Dockerfile

  - name: my-k8s-resource
    kubernetes:
      # Resource potentially referencing the 'CONTAINER_IMAGE' variable.
      # Might be inlined as well.
      uri: 'k8s/my-resource.yaml'

commands:
  - id: build-image
    apply:
      component: image-build-component

  - id: create-k8s-resource
    apply:
      component: my-k8s-resource

  - id: install
    exec:
      commandLine: npm install
      component: runtime
      workingDir: /projects

  - id: start
    exec:
      workingDir: /projects
      commandLine: npm start
      component: runtime

  - id: run
    composite:
      commands:
        - build-image
        - create-k8s-resource
        - install
        - start
      group:
        isDefault: true
        kind: run
